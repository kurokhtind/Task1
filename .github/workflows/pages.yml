name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # –ü–æ—Å–ª–µ–¥–Ω—è—è LTS –≤–µ—Ä—Å–∏—è
          cache: 'npm'
      
      # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
      - name: üì¶ Install dependencies
        run: npm install  # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π, —á–µ–º npm install
      
      # 4. –°–æ–±–∏—Ä–∞–µ–º –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      - name: üèóÔ∏è Build web app
        run: npm run build
      
      # 5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Android SDK
      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v3
      
      # 6. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Capacitor –∏ —Å–æ–±–∏—Ä–∞–µ–º Android –ø—Ä–æ–µ–∫—Ç
      - name: ‚ö° Build with Capacitor
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Capacitor –≥–ª–æ–±–∞–ª—å–Ω–æ (–º–æ–∂–Ω–æ –∏ –ª–æ–∫–∞–ª—å–Ω–æ)
          npm install -g @capacitor/cli
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Capacitor –µ—Å–ª–∏ –Ω–µ—Ç capacitor.config.json
          if [ ! -f "capacitor.config.json" ]; then
            npx cap init "MyApp" "com.example.myapp"
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º Android –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
          npx cap add android
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤–µ–±-—Ñ–∞–π–ª—ã –≤ Android –ø—Ä–æ–µ–∫—Ç
          npx cap copy
          
          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
          npx cap sync android
      
      # 7. –°–æ–±–∏—Ä–∞–µ–º APK
      - name: üî® Build APK
        run: |
          cd android
          chmod +x ./gradlew  # –î–µ–ª–∞–µ–º gradlew –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
          ./gradlew assembleDebug
      
      # 8. –ó–∞–≥—Ä—É–∂–∞–µ–º APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º v4)
      - name: üì§ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            android/app/build/outputs/apk/debug/*.apk
            android/app/build/outputs/apk/debug/output-metadata.json
          retention-days: 7
      
      # 9. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ–∑–¥–∞—ë–º —Ä–µ–ª–∏–∑
      - name: üöÄ Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: android/app/build/outputs/apk/debug/*.apk
