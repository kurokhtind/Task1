name: Build Android APK

on: [push]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Получаем код
    - uses: actions/checkout@v4
    
    # 2. Устанавливаем Node.js (БЕЗ кэширования)
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # 3. Создаём dist папку и копируем файлы
    - name: Prepare web files
      run: |
        mkdir -p dist
        # Копируем HTML, CSS, JS файлы
        cp *.html dist/ 2>/dev/null || true
        cp *.css dist/ 2>/dev/null || true
        cp *.js dist/ 2>/dev/null || true
        # Копируем папки если они есть
        [ -d "css" ] && cp -r css dist/
        [ -d "js" ] && cp -r js dist/
        [ -d "images" ] && cp -r images dist/
        [ -d "assets" ] && cp -r assets dist/
    
    # 4. Устанавливаем Capacitor
    - name: Install Capacitor
      run: |
        npm install -g @capacitor/cli
        npx cap init "MyApp" "com.example.myapp" --web-dir dist -y
        npx cap add android
        npx cap copy
    
    # 5. Устанавливаем Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    # 6. Собираем APK
    - name: Build APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug
    
    # 7. Загружаем APK
    - uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: android/app/build/outputs/apk/debug/*.apk
