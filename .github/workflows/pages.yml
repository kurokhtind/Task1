name: Build Android APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Fix package.json name
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ package.json
        if [ -f "package.json" ]; then
          echo "–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è –≤ package.json..."
          # –£–±–∏—Ä–∞–µ–º –¥–≤–æ–µ—Ç–æ—á–∏–µ –∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—É –∏–∑ –∏–º–µ–Ω–∏
          sed -i 's/"name":.*/"name": "levelup-gamification-life",/' package.json
          # –ò–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å
          echo '{
            "name": "levelup-app",
            "version": "1.0.0",
            "private": true
          }' > package.json
        else
          # –°–æ–∑–¥–∞—ë–º package.json —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
          echo '{
            "name": "levelup-app",
            "version": "1.0.0",
            "private": true
          }' > package.json
        fi
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å
        cat package.json
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Create web content
      run: |
        # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –≤–µ–±-—Ñ–∞–π–ª–æ–≤
        mkdir -p www
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ index.html –≤ –ø—Ä–æ–µ–∫—Ç–µ
        if [ -f "index.html" ]; then
          echo "–ö–æ–ø–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π index.html..."
          cp index.html www/
        else
          # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç–æ–π index.html
          echo '<!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>LevelUp App</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
              h1 { color: #4CAF50; }
            </style>
          </head>
          <body>
            <h1>üéÆ LevelUp App</h1>
            <p>–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –∂–∏–∑–Ω–∏ –¥–ª—è Android</p>
          </body>
          </html>' > www/index.html
        fi
        
        # –ö–æ–ø–∏—Ä—É–µ–º –¥—Ä—É–≥–∏–µ –≤–µ–±-—Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        cp *.css www/ 2>/dev/null || true
        cp *.js www/ 2>/dev/null || true
        [ -d "css" ] && cp -r css www/
        [ -d "js" ] && cp -r js www/
        [ -d "assets" ] && cp -r assets www/
        
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ www:"
        ls -la www/
    
    - name: Install Capacitor
      run: |
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Capacitor –±–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        npm install @capacitor/core @capacitor/cli @capacitor/android
    
    - name: Configure Capacitor
      run: |
        # –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è Capacitor
        echo '{
          "appId": "com.levelup.app",
          "appName": "LevelUp",
          "webDir": "www",
          "bundledWebRuntime": false
        }' > capacitor.config.json
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Capacitor (–Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)
        npx cap init "LevelUp" "com.levelup.app" --web-dir www
        
        # –î–æ–±–∞–≤–ª—è–µ–º Android
        npx cap add android
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
        npx cap copy
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
        npx cap sync
    
    - name: Setup Android SDK
      run: |
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Java
        sudo apt update
        sudo apt install -y openjdk-11-jdk
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Android SDK
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        
        # –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É Android SDK
        mkdir -p android-sdk/cmdline-tools
        mv cmdline-tools android-sdk/cmdline-tools/latest
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        export ANDROID_HOME=$(pwd)/android-sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
        
        # –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–∏
        yes | sdkmanager --licenses >/dev/null 2>&1
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0" >/dev/null 2>&1
    
    - name: Build APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug
    
    - uses: actions/upload-artifact@v4
      with:
        name: levelup-apk
        path: android/app/build/outputs/apk/debug/*.apk
