name: Build Android APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Prepare dist folder
      run: |
        # Удаляем старые папки
        rm -rf dist android
        
        # Создаём dist и копируем файлы
        mkdir -p dist
        
        # Копируем HTML файлы
        find . -name "*.html" -not -path "./node_modules/*" -not -path "./dist/*" -exec cp {} dist/ \;
        
        # Копируем CSS файлы
        find . -name "*.css" -not -path "./node_modules/*" -not -path "./dist/*" -exec cp {} dist/ \;
        
        # Копируем JS файлы
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" -exec cp {} dist/ \;
        
        # Если нет index.html, создаём его
        if [ ! -f "dist/index.html" ]; then
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <title>My App</title>
          </head>
          <body>
              <h1>Welcome to My App</h1>
              <p>This is a web application converted to Android.</p>
          </body>
          </html>
          EOF
          echo "Created default index.html"
        fi
        
        echo "Files in dist:"
        ls -la dist/
    
    - name: Install Capacitor
      run: |
        # Устанавливаем Capacitor глобально
        npm install -g @capacitor/cli @capacitor/core @capacitor/android
    
    - name: Initialize Capacitor
      run: |
        # Создаём конфигурационный файл вручную
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "com.myapp.android",
          "appName": "MyApp",
          "webDir": "dist",
          "bundledWebRuntime": false
        }
        EOF
        
        # Инициализируем Capacitor без интерактивного режима
        npx cap init "MyApp" "com.myapp.android" --web-dir dist
        
        # Добавляем Android платформу
        npx cap add android
        
        # Копируем файлы
        npx cap copy
        
        # Синхронизируем
        npx cap sync
    
    - name: Setup Android SDK
      run: |
        # Устанавливаем Java
        apt-get update
        apt-get install -y openjdk-11-jdk
        
        # Создаём Android SDK директорию
        mkdir -p /home/runner/android-sdk
        
        # Скачиваем Command Line Tools
        cd /home/runner/android-sdk
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        
        # Настраиваем переменные окружения
        echo "ANDROID_SDK_ROOT=/home/runner/android-sdk" >> $GITHUB_ENV
        echo "PATH=$PATH:/home/runner/android-sdk/cmdline-tools/bin" >> $GITHUB_ENV
        
        # Принимаем лицензии
        yes | cmdline-tools/bin/sdkmanager --licenses || true
        
        # Устанавливаем необходимые компоненты
        cmdline-tools/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
        
        # Возвращаемся в рабочую директорию
        cd /home/runner/work/$(echo ${{ github.repository }} | cut -d'/' -f2)/
    
    - name: Build APK
      run: |
        # Переходим в Android директорию
        cd android
        
        # Даём права на выполнение gradlew
        chmod +x gradlew
        
        # Собираем APK
        ./gradlew assembleDebug --no-daemon
    
    - uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: android/app/build/outputs/apk/debug/*.apk
