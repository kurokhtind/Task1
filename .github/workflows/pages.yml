name: Build Web to Android APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js and npm
      run: |
        # Устанавливаем Node.js вручную (без setup-node action)
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
        
        # Проверяем установку
        node --version
        npm --version
    
    - name: Create project structure
      run: |
        # Создаём папку для веб-приложения
        mkdir -p www
        
        # Копируем существующие файлы или создаём демо
        if ls *.html 1> /dev/null 2>&1; then
          cp *.html www/ 2>/dev/null || true
        else
          echo '<!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>My Application</title>
            <style>
              body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
              h1 { color: #2196F3; }
            </style>
          </head>
          <body>
            <h1>My Web App</h1>
            <p>Successfully converted to Android APK!</p>
          </body>
          </html>' > www/index.html
        fi
        
        # Копируем остальные файлы
        cp *.css www/ 2>/dev/null || true
        cp *.js www/ 2>/dev/null || true
    
    - name: Install Capacitor with specific version
      run: |
        # Устанавливаем конкретную версию Capacitor (более стабильную)
        npm init -y
        npm install @capacitor/core@^5.0.0 @capacitor/cli@^5.0.0 @capacitor/android@^5.0.0
    
    - name: Configure Capacitor manually
      run: |
        # Создаём конфигурационный файл вручную
        cat > capacitor.config.json << 'CONFIG'
        {
          "appId": "com.mycompany.myapp",
          "appName": "MyApp",
          "webDir": "www",
          "bundledWebRuntime": false,
          "plugins": {
            "SplashScreen": {
              "launchShowDuration": 3000
            }
          }
        }
        CONFIG
        
        # Инициализируем Capacitor (пропускаем вопросы)
        npx cap init --app-name "MyApp" --app-id "com.mycompany.myapp" --web-dir www --npm-client npm --force
        
        # Добавляем Android платформу
        npx cap add android
    
    - name: Copy web assets to Android
      run: |
        npx cap copy
        npx cap sync android
    
    - name: Setup Android build environment
      run: |
        # Устанавливаем Java 11
        sudo apt update
        sudo apt install -y openjdk-11-jdk-headless
        
        # Скачиваем Android Command Line Tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        
        # Создаём структуру Android SDK
        mkdir -p android-sdk
        mv cmdline-tools android-sdk/
        
        # Устанавливаем переменные окружения
        echo "ANDROID_SDK_ROOT=$PWD/android-sdk" >> $GITHUB_ENV
        echo "PATH=$PATH:$PWD/android-sdk/cmdline-tools/bin" >> $GITHUB_ENV
        
        # Принимаем лицензии (автоматически)
        yes | $PWD/android-sdk/cmdline-tools/bin/sdkmanager --licenses > /dev/null 2>&1
        
        # Устанавливаем необходимые компоненты
        $PWD/android-sdk/cmdline-tools/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0" > /dev/null 2>&1
    
    - name: Build Android APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug --no-daemon --stacktrace
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-application
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
