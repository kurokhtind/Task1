name: Build APK from Web App

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create web files
      run: |
        # Удаляем старые папки если есть
        rm -rf dist android
        
        # Создаём новую папку
        mkdir dist
        
        # Создаём простой index.html
        echo '<html>' > dist/index.html
        echo '<head><title>My App</title></head>' >> dist/index.html
        echo '<body><h1>Hello World</h1><p>Android App</p></body>' >> dist/index.html
        echo '</html>' >> dist/index.html
        
        # Показываем что получилось
        ls -la dist/
    
    - name: Setup Capacitor
      run: |
        # Устанавливаем Capacitor
        npm install -g @capacitor/cli
        
        # Создаём конфиг
        echo '{"appId":"com.myapp.android","appName":"MyApp","webDir":"dist"}' > capacitor.config.json
        
        # Инициализируем
        echo "" | npx cap init
        
        # Добавляем Android
        npx cap add android
        
        # Копируем файлы
        npx cap copy
    
    - name: Setup Android
      run: |
        # Устанавливаем Java
        sudo apt update
        sudo apt install -y openjdk-11-jdk wget unzip
        
        # Скачиваем Android SDK
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip commandlinetools-linux-9477386_latest.zip
        
        # Создаём структуру
        mkdir -p android-sdk/cmdline-tools
        mv cmdline-tools android-sdk/cmdline-tools/latest
        
        # Настраиваем переменные
        export ANDROID_SDK_ROOT=$(pwd)/android-sdk
        export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin
        
        # Принимаем лицензии (автоматически)
        yes | sdkmanager --licenses > /dev/null 2>&1
        
        # Устанавливаем компоненты
        sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
    
    - name: Build APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug
    
    - uses: actions/upload-artifact@v4
      with:
        name: app-apk
        path: android/app/build/outputs/apk/debug/*.apk
